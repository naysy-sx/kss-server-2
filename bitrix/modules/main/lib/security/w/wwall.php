<? namespace Bitrix\Main\Security\W;$GLOBALS['____1943660910']= array(base64_decode('dGltZQ=='),base64_decode('dGl'.'tZQ'.'=='),base64_decode('anNvb'.'l9kZWNvZGU='),base64_decode('YXJyYX'.'lfb'.'WVy'.'Z'.'2U='),base64_decode('am9p'.'bg=='),base64_decode('am9pbg='.'='),base64_decode('am9p'.'bg=='),base64_decode('Y'.'XJyYXlfcG'.'9w'),base64_decode('YXJyYXl'.'fc2hp'.'ZnQ='),base64_decode('Y'.'XJ'.'yYX'.'lfc2hpZnQ='),base64_decode('YXJy'.'YXlfc2hpZ'.'nQ='),base64_decode('YXJyYXlfc2hpZnQ='),base64_decode('YX'.'JyYXlfbWVyZ'.'2U'.'='),base64_decode('aX'.'NfYXJyYXk='),base64_decode('Y'.'XJyY'.'Xl'.'fb'.'WV'.'y'.'Z'.'2U='),base64_decode('aW5fYXJy'.'YXk='),base64_decode(''.'a'.'W5fYX'.'JyYXk'.'='),base64_decode('aW5fY'.'XJyY'.'Xk'.'='),base64_decode('aW5'.'fYX'.'JyYXk='),base64_decode(''.'aW5fY'.'XJ'.'y'.'YXk='),base64_decode('dGltZ'.'Q=='),base64_decode('dGltZQ=='),base64_decode('YXJ'.'yYX'.'lfbWFw'),base64_decode('Z2V0'.'X'.'2xvYWRl'.'ZF9l'.'eH'.'R'.'lbnNpb25z'),base64_decode(''.'anNvbl'.'9lbmNvZ'.'GU='),base64_decode(''.'an'.'Nvbl9lbmNvZGU='),base64_decode('c'.'Ghw'.'dmVyc2lvb'.'g=='),base64_decode('an'.'Nvb'.'l9lbmNv'.'ZGU='),base64_decode('am9pb'.'g=='));if(!function_exists(__NAMESPACE__.'\\___2114465739')){function ___2114465739($_1112912539){static $_1639732818= false; if($_1639732818 == false) $_1639732818=array('V1d'.'BTExfT'.'E9D'.'Sw'.'==','c2'.'VjdXJp'.'d'.'H'.'k=','RE'.'FUQQ'.'==','e'.'yI=','V'.'1dBTExfTE9DSw='.'=',''.'c2V'.'jdXJp'.'dHk=','U0VDVV'.'JJVFlfV1'.'d'.'BT'.'E'.'xfRVhDRV'.'BUSU'.'9O',''.'RkFJT'.'F9DSEVDS0'.'lORw==','Q2'.'FuIG5vdCBleG'.'Vj'.'dXRlIHd3YW'.'xsIHJ'.'1bGV'.'zOiA'.'=','IFRyYW'.'NlOiA=',''.'Uk'.'V'.'R'.'V'.'UV'.'TVF9VUkk=','a2V5'.'cw='.'=','dmFsdWVz','U0V'.'DVVJJVF'.'lfV1dB'.'TEx'.'f'.'T'.'U9ES'.'UZZ','Lg==','U'.'0VDV'.'VJJV'.'FlfV1dBT'.'ExfVU5T'.'RV'.'Q=',''.'Lg==','U0V'.'DVVJJVFlfV1'.'dBTE'.'xfRV'.'hJVA==','Lg==','Z2x'.'vYmFs',''.'a2V5cw==','dmFsdW'.'Vz','Z'.'2V0','Z2'.'V0','cG'.'9'.'zdA==',''.'cG9'.'z'.'dA='.'=','Y2'.'9'.'va2ll','Y29va'.'2'.'ll','cmV'.'x'.'dWVzdA='.'=',''.'cmVxdW'.'V'.'zd'.'A'.'==',''.'Z'.'2xvY'.'mFs',''.'Z2xvYmFs',''.'bWFpbl9zZWM=','V'.'1dB'.'T'.'ExfQUNUVUFMSVpFX'.'1JVTEVT','dg='.'=','dmVyc2lv'.'bg==','aQ==','aXNJbnN0Y'.'WxsZ'.'WQ=','dg'.'==','a'.'W5p','bW9kdWxlc'.'w==','bG'.'l'.'jZW5zZQ='.'=','c'.'Ghw','dg==','ZXh'.'0','c2VjdXJpd'.'H'.'k=','Z'.'GI=','dHlwZQ==','Z'.'GI=','dmVyc'.'2lvb'.'g==','ZG'.'I=','dHlwZQ==','ZGI=',''.'dHlwZQ'.'==','dmVyc2lv'.'bg==','ZGI=',''.'dmVy'.'c2lvb'.'g==','ZW5'.'2aXJv'.'bm'.'1lbn'.'Q=','dm1'.'fdmVyc2'.'lvbg==','dm'.'0'.'=','dg==','ZW5'.'2aXJvbm1'.'lbnQ=','dm1fdmV'.'yc2lvbg==',''.'c29'.'ja2'.'V0VG'.'ltZW91'.'dA==',''.'c3RyZWFtV'.'G'.'ltZW9'.'1dA==','KCc'.'=',''.'ZGF0YQ'.'==','JywgJw='.'=','bW9kdWxl','JywgJw='.'=','bW9'.'kdWx'.'l'.'X3ZlcnNp'.'b24=',''.'J'.'yk=','LCA=','U0V'.'DVVJJVF'.'lfV'.'1dBTExfRVhDR'.'VBUSU9O','bWFp'.'bg'.'='.'=','RkFJTF'.'9SRUZSR'.'V'.'NISU5'.'H','Q'.'2FuIG5vd'.'CByZWZyZX'.'N'.'o'.'IHd'.'3Y'.'Wxs'.'IHJ1bGVzOiA=','IFRyYWNlOiA=','ZG'.'F0YQ==','e'.'y'.'I'.'=','L'.'S0tLS1CR'.'U'.'dJ'.'TiBQV'.'U'.'JMSUMg'.'S0'.'V'.'Z'.'L'.'S0tL'.'S0=',''.'Ck1JSUJJa'.'kFOQ'.'md'.'rcWh'.'ra'.'Uc5d'.'zBCQVFFRkFBT0'.'NBUThBTU'.'lJQkNnS'.'0'.'NBU'.'UVBcThR'.'RT'.'BIam'.'1'.'IS'.'l'.'VTdF'.'dWNm4wemEK'.'UlZvTHg'.'w'.'M'.'kt6YmZyYlMvU'.'DZz'.'V2F'.'4V'.'Hp3OFNlR1R0Yl'.'R'.'DT3J'.'wSGk1'.'UUY2T1J'.'5alovWHh6L0'.'tMV'.'TFHY'.'m'.'9'.'m'.'OUNaMw'.'o0ejdT'.'a3FVdDY2aWJYdk'.'9GQn'.'g0ZncvQVBQ'.'U'.'kdEcXRtMG5EM2ZnR3N1M1J'.'lUGd3Mjl'.'pOCt2bT'.'dtdEJ'.'LSl'.'VZ'.'bD'.'R'.'y'.'Cl'.'Zw'.'YjZzZlpFVDlLRWI2V'.'DFIRFltRX'.'ZjMWhxL2lp'.'d'.'Xl4T'.'HJaW'.'mk1UT'.'ZVZm'.'Y0VUV'.'2VEk'.'r'.'Njhzc0ZSa1Erb3dUUnk'.'KZU9J'.'T'.'WJGaE'.'0vV'.'VRtZlZZYl'.'RS'.'Rn'.'ky'.'b1'.'VROF'.'dNemEybko1U2Fo'.'emk'.'xV'.'UtP'.'MWpBalhUUFJyemM3QWp'.'1Nj'.'M5'.'aj'.'FPMApwc'.'H'.'FmbTV4Z1'.'dsRk'.'FKa'.'0hRVGdiZGQ1Q'.'VdxR'.'EZ'.'Ra3Q5SEtr'.'WStUbmZCT'.'E'.'dWTXZWeV'.'B3'.'V'.'EhOV1F'.'Z'.'QXc0eH'.'BnL3dBClp3SURBUU'.'FCCi'.'0'.'tLS0tRU5EIFBVQkxJ'.'QyBL'.'R'.'VktLS0t'.'LQ'.'==');return base64_decode($_1639732818[$_1112912539]);}}; use Bitrix\Main\Application; use Bitrix\Main\Config\Option; use Bitrix\Main\Data\Cache; use Bitrix\Main\Loader; use Bitrix\Main\ModuleManager; use Bitrix\Main\Security\PublicKeyCipher; use Bitrix\Main\SystemException; use Bitrix\Main\Web\HttpClient; use Bitrix\Main\Web\Json; use Bitrix\Main\Security\W\Rules\Rule; use Bitrix\Main\Security\W\Rules\Results\RuleAction; use Bitrix\Main\Security\W\Rules\Results\RuleResult; use Bitrix\Main\Security\W\Rules\Results\CheckResult; use Bitrix\Main\Security\W\Rules\Results\ModifyResult; use Bitrix\Main\Type\ArrayHelper; use Bitrix\Main\Security\W\Rules\RuleRecordTable; use CSecuritySystemInformation; use ReflectionExtension; class WWall{ const CACHE_RULES_TTL= 10800; private static $_1054614355= 'https://wwall.bitrix.info/rules.php'; protected $_418909320= true; public function handle(){ try{  $_281161539= RuleRecordTable::getList([ 'cache' =>['ttl' => 3600* 24* 7]])->fetchAll(); if(empty($_281161539)){ return;}  $_856921069= Cache::createInstance(); $_1342935868= false; if($_856921069->initCache(static::CACHE_RULES_TTL, 'WWALL_LOCK', 'security')){ $_403757977= $_856921069->getVars(); if($GLOBALS['____1943660910'][0]()- $_403757977> round(0+5+5+5+5)){  $_34007447= Application::getConnection(); $_897875328= RuleRecordTable::getTableName(); $_34007447->truncateTable($_897875328); RuleRecordTable::cleanCache(); $_856921069->clean(___2114465739(0), ___2114465739(1));}} elseif($_856921069->startDataCache()){  $_856921069->endDataCache($GLOBALS['____1943660910'][1]()); $_1342935868= true;} foreach($_281161539 as $_640276750){ $_26639679= new PublicKeyCipher; $_1256895363= $_26639679->decrypt($_640276750[___2114465739(2)], static::__1885249293()); if(!str_starts_with($_1256895363, ___2114465739(3))){ continue;} $_1364138585= $GLOBALS['____1943660910'][2]($_1256895363, true); if(!empty($_1364138585)){ $_1918420376= Rule::make($_1364138585); $_418913343= $this->handleRule($_1918420376); $this->applyHandlingResults($_418913343);}}  if($_1342935868){ $_856921069->clean(___2114465739(4), ___2114465739(5));}} catch(\Throwable $_284250868){ $this->logEvent( ___2114465739(6), ___2114465739(7), ___2114465739(8). $_284250868->getMessage(). ___2114465739(9). $_284250868->getTraceAsString());}}  public function handleRule(Rule $_1918420376): array{ $_418913343=[]; if($_1918420376->matchPath($_SERVER[___2114465739(10)])){  $_1694926431= $this->getContextElements($_1918420376->getContext()); foreach($_1694926431 as $_1695582924 => &$_34539580){ $_418913343= $GLOBALS['____1943660910'][3]($_418913343, $this->recursiveContextKeyHandle($_1695582924, $_34539580,[], $_1918420376));}} return $_418913343;}  public function applyHandlingResults(array $_418913343){ $_1694926431= $this->getContextElements([ 'get', 'post', 'cookie', 'request', 'global']); foreach($_418913343 as $_1923611666){ $_34539580=& $_1694926431[$_1923611666->getContextName()]; $_1409709864= $_1923611666->getRuleResult(); $_1918420376= $_1923611666->getRule(); if($_1409709864 instanceof ModifyResult){ if($_1918420376->getProcess() === ___2114465739(11)){  static::rewriteContextKey( $_1923611666->getContextName(), $_34539580, $_1923611666->getContextKey(), $_1409709864->getCleanValue());} elseif($_1918420376->getProcess() === ___2114465739(12)){ static::rewriteContextValue( $_1923611666->getContextName(), $_34539580, $_1923611666->getContextKey(), $_1409709864->getCleanValue());} $this->logEvent( ___2114465739(13), $_1923611666->getContextName(), $GLOBALS['____1943660910'][4](___2114465739(14), $_1923611666->getContextKey()));} elseif($_1409709864 instanceof CheckResult &&!$_1409709864->isSuccess()){ if($_1409709864->getAction() === RuleAction::UNSET){ static::unsetContextValue( $_1923611666->getContextName(), $_34539580, $_1923611666->getContextKey(),); $this->logEvent( ___2114465739(15), $_1923611666->getContextName(), $GLOBALS['____1943660910'][5](___2114465739(16), $_1923611666->getContextKey()));} elseif($_1409709864->getAction() === RuleAction::EXIT){ $this->logEvent( ___2114465739(17), $_1923611666->getContextName(), $GLOBALS['____1943660910'][6](___2114465739(18), $_1923611666->getContextKey())); exit;}}}} public function disableEventLogging(){ $this->_418909320= false;} protected function rewriteContextKey($_1695582924, &$_34539580, $_241734992, $_1166005983){ $_56763367= $_241734992;  $GLOBALS['____1943660910'][7]($_56763367); $_56763367[]= $_1166005983; if($_1695582924 === ___2114465739(19)){ $_866744623= $GLOBALS['____1943660910'][8]($_241734992); $GLOBALS['____1943660910'][9]($_56763367); if(empty($_241734992)){ $GLOBALS[$_1166005983]= $GLOBALS[$_866744623]; unset($GLOBALS[$_866744623]);} else{ $_34539580=& $GLOBALS[$_866744623]; $_1426494845= ArrayHelper::getByNestedKey($_34539580, $_241734992);  ArrayHelper::setByNestedKey($_34539580, $_56763367, $_1426494845);  ArrayHelper::unsetByNestedKey($_34539580, $_241734992);}} else{ $_1426494845= ArrayHelper::getByNestedKey($_34539580, $_241734992);  ArrayHelper::setByNestedKey($_34539580, $_56763367, $_1426494845);  ArrayHelper::unsetByNestedKey($_34539580, $_241734992);}} protected function rewriteContextValue($_1695582924, &$_34539580, $_1891844900, $_1426494845){ if($_1695582924 === 'global'){ $_866744623= $GLOBALS['____1943660910'][10]($_1891844900); if(empty($_1891844900)){ $GLOBALS[$_866744623]= $_1426494845;} else{ $_34539580=& $GLOBALS[$_866744623]; ArrayHelper::setByNestedKey($_34539580, $_1891844900, $_1426494845);}} else{  ArrayHelper::setByNestedKey($_34539580, $_1891844900, $_1426494845);}} protected function unsetContextValue($_1695582924, &$_34539580, $_1891844900){ if($_1695582924 === 'global'){ $_866744623= $GLOBALS['____1943660910'][11]($_1891844900); if(empty($_1891844900)){ unset($GLOBALS[$_866744623]);} else{ $_34539580=& $GLOBALS[$_866744623]; ArrayHelper::unsetByNestedKey($_34539580, $_1891844900);}} else{ ArrayHelper::unsetByNestedKey($_34539580, $_1891844900);}}  protected function recursiveContextKeyHandle(string $_1695582924, array &$_34539580, array $_1634277142, Rule $_1918420376): array{  $_418913343=[]; foreach($_34539580 as $_612635904 => $_1426494845){ $_1891844900= $GLOBALS['____1943660910'][12]($_1634277142,[$_612635904]); if($_1918420376->matchKey($_1891844900)){  if($_1918420376->getProcess() === ___2114465739(20)){ $_1409709864= $_1918420376->evaluate($_612635904);} elseif($_1918420376->getProcess() === ___2114465739(21)){ $_1409709864= $_1918420376->evaluateValue($_1426494845);}  if(!empty($_1409709864) && $_1409709864 instanceof RuleResult){ $_418913343[]= new HandlingResult($_1695582924, $_1891844900, $_1409709864, $_1918420376);}}  if($GLOBALS['____1943660910'][13]($_1426494845)){ $_418913343= $GLOBALS['____1943660910'][14]($_418913343, $this->recursiveContextKeyHandle( $_1695582924, $_34539580[$_612635904], $_1891844900, $_1918420376));}} return $_418913343;} protected function getContextElements(array $_1062588146){ $_393404550=[]; if($GLOBALS['____1943660910'][15](___2114465739(22), $_1062588146, true)){ $_393404550[___2114465739(23)]= &$_GET;} if($GLOBALS['____1943660910'][16](___2114465739(24), $_1062588146, true)){ $_393404550[___2114465739(25)]= &$_POST;} if($GLOBALS['____1943660910'][17](___2114465739(26), $_1062588146, true)){ $_393404550[___2114465739(27)]= &$_COOKIE;} if($GLOBALS['____1943660910'][18](___2114465739(28), $_1062588146, true)){ $_393404550[___2114465739(29)]= &$_REQUEST;} if($GLOBALS['____1943660910'][19](___2114465739(30), $_1062588146, true)){ $_393404550[___2114465739(31)]= $GLOBALS;} return $_393404550;} public static function refreshRules(){ try{ $_196855870= Option::get('main_sec', 'WWALL_ACTUALIZE_RULES', 0); if(($GLOBALS['____1943660910'][20]()- $_196855870)< static::CACHE_RULES_TTL){ return;} Option::set(___2114465739(32), ___2114465739(33), $GLOBALS['____1943660910'][21]()); $_2129685811= null;  $_1789188812= $GLOBALS['____1943660910'][22](function($_2053948521){ return[___2114465739(34) => $_2053948521[___2114465739(35)], ___2114465739(36) => (int) $_2053948521[___2114465739(37)]];}, ModuleManager::getModulesFromDisk());  $_1602642787=[]; foreach($GLOBALS['____1943660910'][23]() as $_2125500886){ $_562068870= new ReflectionExtension($_2125500886); $_1602642787[$_2125500886]=[ ___2114465739(38) => $_562068870->getVersion(), ___2114465739(39) => $_562068870->getINIEntries()];} $_1021066039=[ ___2114465739(40) => $GLOBALS['____1943660910'][24]($_1789188812), ___2114465739(41) => Application::getInstance()->getLicense()->getHashLicenseKey(), ___2114465739(42) => $GLOBALS['____1943660910'][25]([ ___2114465739(43) => $GLOBALS['____1943660910'][26](), ___2114465739(44) => $_1602642787])]; if(Loader::includeModule(___2114465739(45))){ $_544011187= CSecuritySystemInformation::getSystemInformation(); if(isset($_544011187[___2114465739(46)][___2114465739(47)]) && isset($_544011187[___2114465739(48)][___2114465739(49)])){ $_1021066039[___2114465739(50)]=[ ___2114465739(51) => $_544011187[___2114465739(52)][___2114465739(53)], ___2114465739(54) => $_544011187[___2114465739(55)][___2114465739(56)]];} if(isset($_544011187[___2114465739(57)][___2114465739(58)])){ $_1021066039[___2114465739(59)]=[___2114465739(60) => $_544011187[___2114465739(61)][___2114465739(62)]];}}  $_487015957= new HttpClient([ ___2114465739(63) => round(0+1+1+1+1+1), ___2114465739(64) => round(0+1+1+1+1+1)]); $_487123035= $_487015957->post( static::$_1054614355, $_1021066039); if($_487015957->getStatus() == round(0+50+50+50+50) &&!empty($_487123035)){ $_2129685811= Json::decode($_487123035);}  if($_2129685811 !== null){ $_34007447= Application::getConnection(); $_897875328= RuleRecordTable::getTableName(); if(!empty($_2129685811)){ foreach($_2129685811 as $_752923418){ if(!static::checkRuleSign($_752923418)){ throw new SystemException('Invalid sign for rule '.$GLOBALS['____1943660910'][27]($_752923418));}}}  $_34007447->truncateTable($_897875328);  if(!empty($_2129685811)){ $_1233947911=[]; foreach($_2129685811 as $_752923418){ $_1233947911[]= ___2114465739(65). $_34007447->getSqlHelper()->forSql($_752923418[___2114465739(66)]). ___2114465739(67). $_34007447->getSqlHelper()->forSql($_752923418[___2114465739(68)]). ___2114465739(69). $_34007447->getSqlHelper()->forSql($_752923418[___2114465739(70)]). ___2114465739(71);} $_724359288= $GLOBALS['____1943660910'][28](___2114465739(72), $_1233947911);  $_34007447->query("INSERT INTO {$_897875328} (DATA, MODULE, MODULE_VERSION) VALUES {$_724359288}");  RuleRecordTable::cleanCache();}}} catch(\Throwable $_284250868){ \CEventLog::log( \CEventLog::SEVERITY_SECURITY, ___2114465739(73), ___2114465739(74), ___2114465739(75), ___2114465739(76). $_284250868->getMessage(). ___2114465739(77). $_284250868->getTraceAsString());}} protected static function checkRuleSign($_1918420376){ $_26639679= new PublicKeyCipher; $_1364138585= $_26639679->decrypt($_1918420376[___2114465739(78)], static::__1885249293()); return str_starts_with($_1364138585, ___2114465739(79));} private static function __1885249293(){ $_150535728= ''; $_150535728 .= ___2114465739(80); $_150535728 .= ___2114465739(81); return $_150535728;} protected function logEvent($_548139734, $_1687865649, $_64202747){ if($this->_418909320){ \CEventLog::log( \CEventLog::SEVERITY_SECURITY, $_548139734, 'main', $_1687865649, $_64202747);}}}?>